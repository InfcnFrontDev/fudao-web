<!DOCTYPE html>
<html style="width: 100%;height:100%;">

<head>
    <meta charset="UTF-8">
    <title>Hello MUI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <!--<meta name="apple-mobile-web-app-capable" content="yes">-->
    <!--<meta name="apple-mobile-web-app-status-bar-style" content="black">-->
    <!--标准mui.css-->
    <link rel="stylesheet" href="venders/css/mui.min.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="css/_all.css">
    <link rel="stylesheet" href="css/custom.css">
    <script src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/mui.min.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/source/config.js"></script>
    <script type="text/javascript" src="js/source/localstorage.js"></script>
    <script type="text/javascript" src="js/source/public.js"></script>
    <script type="text/javascript" src="js/privatejs/question.js"></script>
    <script src="js/config.js"></script>
    <script src="js/data.js"></script>

</head>
<style>
    .question {
        background-color: #FFFFFF;
        text-align: left;
        vertical-align: middle;
        min-height: 50px;
        padding: 20px 15px 10px 10px;
        font-size: 18px;
        line-height: 22px;
    }

    .answer {
        padding-left: 10px;
        font-size: 18px;
        white-space: nowrap;
    }

    ._index {
        float: left;
        width: 20px;
        height: 20px;
        text-align: center;
        border-radius: 10px;
        line-height: 20px;
        font-size: 14px;
    }

    .mui-demo-container {
        background-color: #fff;
        padding: 10px 15px 0px 15px;
    }

    .mui-progressbar-royal span {
        background-color: #a1cc00;
    }

    .mui-progressbar {
        height: 5px;
    }

    .mui-input-group .mui-input-row:after {
        left: 0px;
    }
</style>


<body style="background: rgba(0,0,0,0);width: 100%;height:100%;">
<div style="width:100%;height: 100%;position: relative;display: flex;flex-direction: column">

    <div style="background: #67799F">
        <div id="title"
             style=" text-align: left; vertical-align: middle; height: 20px; font-size: 18px; padding: 20px 10px 30px;color: #fff"></div>
        <div id="demo5" class="mui-demo-container" style="background: #67799F;height: 45px;position: relative">
            <p id="answerProgress" class="mui-progressbar mui-progressbar-royal" data-progress="80"
               style="margin-left:10px;width:80%;background: #fff;height: 14px;border-radius: 14px;"><span></span></p>
            <div class="mui-btn mui-btn-link " id="sum"
                 style="color: #C8D1F0; position: absolute;top:2px;right:10px;"></div>
        </div>
    </div>
    <div style="flex: 1;">
        <div id="question" class="question" style='padding-top:20px;padding-left: 16px;border:0'></div>
        <div style="width: 138px;height:80px;margin: 0 auto ">
            <img id="questionImg" style="width: 100%;height: 100%"/>
        </div>
        <div class="mui-input-group">
            <div class="mui-input-row mui-right  answer" id="answer1">
            </div>
            <div class="mui-input-row mui-right answer" id="answer2">
            </div>
            <div class="mui-input-row  mui-right answer" id="answer3">
            </div>
            <div class="mui-input-row  mui-right answer" id="answer4">
            </div>
            <div class="mui-input-row  mui-right answer" id="answer5">
            </div>
        </div>
    </div>
    <div class="mui-bar mui-bar-footer"
         style="height:72px;position:absolute;bottom:20px;padding:20px ;display: flex;justify-content: space-around">
        <button type="button"
                style="width: 100px;border: 1px solid #a1cc00;background-color: #a1cc00;color: white;" id="up">上一题
        </button>
        <button type="button"
                style="width: 100px;border: 1px solid #bfbfbf;background-color: #bfbfbf;color: white;" id="next">下一题
        </button>
        <button type="button"
                style="display: none;width: 100px;border: 1px solid #bfbfbf;background-color: #bfbfbf;color: white;"
                id="submit">提交
        </button>
    </div>
</div>

<script>
    var index = 1;
    var questionnaireType = JSON.parse(localStorage.getItem('questionsType'));
    var key = questionnaireType[2] + "answer";
    var answers = JSON.parse(localStorage.getItem(key)) || [];
    console.log(answers)

    $('#title').html(questionnaireType[1]);
    var _json = [];
    var token = localStorage.getItem('zizhen_token');
    $.ajax({
        type: "post",
        url: urls.DIAGNOSIS_GETQUESTIONNAIRELIST,
        headers: {
            authorization: token
        },
        data: {
            type: questionnaireType[0]
        },
        success: function (res) {
            _json = res.obj;
            var nowI = parseInt(localStorage.getItem(questionnaireType[2]));
            if (nowI) {
                index = Math.ceil(_json.length * nowI / 100);
            }
            fun_getCurQuestion();
        },
        error: function () {
            console.log('err')
        }
    });


    mui('.mui-bar-footer').on('tap', 'button', function () {
        var btnId = this.getAttribute('id');
        if (btnId == 'up') {
            index--;
        } else if (btnId == 'next') {
            index++;
        } else {
            fun_submit();
            return false;
        }
        fun_getCurQuestion();
    });

    // 设置当前问题及答案
    function fun_getCurQuestion() {

        if (questionnaireType[0] != 0 && index != 1) {
            localStorage.setItem(questionnaireType[2], JSON.stringify(Math.ceil((index - 1) / _json.length * 100)) + "%");
            $("." + questionnaireType[2] + " span").html(Math.ceil((index - 1) / _json.length * 100) + "%");
            $("." + questionnaireType[2] + " cite").css('width', 1.3 * Math.ceil((index - 1) / _json.length * 100));
        }
        fun_setButton();
        $("#sum").html(index + "/" + _json.length);
        var curQuestion = _json[index - 1];
        document.getElementById("question").innerHTML = index + " 、" + curQuestion.title;
        document.getElementById("questionImg").setAttribute('src', urls.IMGSRC + curQuestion.img);
        document.getElementById("answer1").innerHTML = fun_createRadio(curQuestion, 0, 'A') + "<label style ='text-align:left;margin-left:28px;'>A&nbsp;&nbsp;&nbsp;" + curQuestion.answer[0] + "</label>";
        document.getElementById("answer2").innerHTML = fun_createRadio(curQuestion, 1, 'B') + "<label style ='text-align:left;margin-left:28px;'>B&nbsp;&nbsp;&nbsp;" + curQuestion.answer[1] + "</label>";
        document.getElementById("answer3").innerHTML = fun_createRadio(curQuestion, 2, 'C') + "<label style ='text-align:left;margin-left:28px;'>C&nbsp;&nbsp;&nbsp;" + curQuestion.answer[2] + "</label>";
        document.getElementById("answer4").innerHTML = fun_createRadio(curQuestion, 3, 'D') + "<label style ='text-align:left;margin-left:28px;'>D&nbsp;&nbsp;&nbsp;" + curQuestion.answer[3] + "</label>";
        document.getElementById("answer5").innerHTML = fun_createRadio(curQuestion, 4, 'E') + "<label style ='text-align:left;margin-left:28px;'>E&nbsp;&nbsp;&nbsp;" + curQuestion.answer[4] + "</label>";
        fun_showProgress(index);
    }

    function fun_showProgress(index) {

        answerProgress.setAttribute('data-progress', (index - 1) / _json.length * 100);
        // 显示进度
        mui("#demo5 .mui-progressbar").each(function () {
            mui(this).progressbar({
                progress: this.getAttribute("data-progress")
            }).show();
        });
    }

    // 生成单选按钮
    function fun_createRadio(question, answer, order) {
        var _radio = '<input class="iradio_square-blue" type="radio" style="-webkit-appearance: none;left:20px;" name="' + question.id + '&' + order + '"';
        _radio += ' value="' + question.asnwerScore[answer] + '"';
        if (answers[question.id] == question.asnwerScore[answer]) {
            _radio += ' checked="checked"';
        }
        _radio += ' onclick="fun_recordingAnswer(this);">';
        return _radio;
    }


    // 记录答案
    function fun_recordingAnswer(obj) {
        var order = obj.name.split('&');
        $(obj).addClass('checked');
        if (index == _json.length) {
            fun_showProgress(index + 1);
            answers[index - 1] = {
                id: order[0],
                score: obj.value,
                answer: order[1]
            };
            localStorage.setItem(key, JSON.stringify(answers));
            fun_submit();
            return false;
        }
        answers[index - 1] = {
            id: order[0],
            score: obj.value,
            answer: order[1]
        };
        localStorage.setItem(key, JSON.stringify(answers));

        index++;
        window.setTimeout("fun_getCurQuestion()", 800);
    }

    // 设置问题上一题/下一题按钮是否可用
    function fun_setButton() {
        if (index == 1) {
            //plus.nativeUI.toast('当前问题已经是第一题');
            document.getElementById("up").style.display = 'none';
        } else if (index == _json.length) {
            document.getElementById("next").style.display = 'none';
            document.getElementById("submit").style.display = 'block';
        } else {
            document.getElementById("up").style.display = 'block';
            document.getElementById("next").style.display = 'block';
            document.getElementById("submit").style.display = 'none';
        }
    }
    // 提交答案
    function fun_submit() {
        var btnArray;
        btnArray = ['取消', '确定'];
        mui.confirm('是否提交问卷', '温馨提示', btnArray, function (e) {

            for (var i in _json) {
                if (!answers[i]) {
                    answers[i] = {
                        id: _json[i].id,
                        score: _json[i].asnwerScore[0],
                        answer: 'A'
                    }
                }
            }

            if (e.index == 1) {
                countScore(answers);
                localStorage.removeItem(key);
                localStorage.removeItem(questionnaireType[2]);
                location.href = "assessmentResult.html";
            } else {

            }

        });
    }

    //提交问卷
    function countScore(answers) {

        $.ajax({
            url: urls.DIAGNOSIS_SUBMITQUESTIONNAIRERESULT,
            headers: {
                authorization: token
            },
            data: {
                result: JSON.stringify(answers)
            },
            dataType: 'json',
            type: 'post',
            timeout: 20000, //超时时间设置为20秒；
            success: function (data) {
                window.location.href = "assessmentResult.html";
            },
            error: function (xhr, type, errorThrown) {
            }
        });


    }


</script>

</body>

</html>