<!DOCTYPE html>
<html style="width:100%;height: 100%;overflow: hidden">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/appraisal.css">
    <script src="js/privatejs/main.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/apprasial.js"></script>
    <script src="js/config.js"></script>
    <link rel="stylesheet" href="venders/css/mui.min.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="css/_all.css">
    <link rel="stylesheet" href="css/custom.css">
    <script type="text/javascript" src="js/mui.min.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script type="text/javascript" src="js/source/config.js"></script>
    <script type="text/javascript" src="js/source/localstorage.js"></script>
    <script type="text/javascript" src="js/source/public.js"></script>
    <script type="text/javascript" src="js/privatejs/question.js"></script>
    <script src="js/data.js"></script>


</head>
<body style="width:100%;height:100%;overflow: hidden">
<div class="appraisalBox">
    <div style="margin:10px auto;width:220px;height:220px;display:flex;justify-content:center;position:relative">
        <div id="div_img" style="display:none;">
            <img src="images/load_fudaozhishu.gif" width="220" height="220"
                 style="position:absolute;top:0;left:0; z-index: 0;"/>
        </div>
        <div id="div_svg">
            <svg width="220" height="220" class="pt-ab pt1">
                <circle cx="110" cy="110" r="70" stroke-width="5" stroke="#C9CACA" fill="none"></circle>
                <circle cx="110" cy="110" r="70" stroke-width="5" stroke="#00cccc" fill="none" id="svg_zhengzhuang"
                        transform="matrix(0,-1,1,0,0,220)"></circle>
            </svg>
            <svg width="220" height="220" class="pt-ab pt2">
                <circle cx="110" cy="110" r="80" stroke-width="5" stroke="#C9CACA" fill="none"></circle>
                <circle cx="110" cy="110" r="80" stroke-width="5" stroke="#66cc00" fill="none" id="svg_xinli"
                        transform="matrix(0,-1,1,0,0,220)"></circle>
            </svg>
            <svg width="220" height="220" class="pt-ab pt3">
                <circle cx="110" cy="110" r="90" stroke-width="5" stroke="#C9CACA" fill="none"></circle>
                <circle cx="110" cy="110" r="90" stroke-width="5" stroke="#cc9900" fill="none" id="svg_shehui"
                        transform="matrix(0,-1,1,0,0,220)"></circle>
            </svg>
            <svg width="220" height="220" class="pt-ab pt4">
                <circle cx="110" cy="110" r="100" stroke-width="5" stroke="#C9CACA" fill="none"></circle>
                <circle cx="110" cy="110" r="100" stroke-width="5" stroke="#ff9900" fill="none" id="svg_zice"
                        transform="matrix(0,-1,1,0,0,220)"></circle>
            </svg>
        </div>

        <div style="position:absolute; top:96px; left:62px;">
            <p class="fdzs">看漫画，来自评</p>
        </div>
    </div>
    <div id="before" class="appraisalMark">
        <div class="jinduBox">
            <a class="appraisalsl" data-reveal-id="myModal"><b>生理测评</b><span>00%</span><i><cite></cite></i></a>
            <a class="appraisalxl" data-reveal-id="myModal"><b>心理测评</b><span>00%</span><i><cite></cite></i></a>
            <a class="appraisalsj" data-reveal-id="myModal"><b>社交测评</b><span>00%</span><i><cite></cite></i></a>
            <a class="appraisalzc" data-reveal-id="myModal"><b>自测测评</b><span>00%</span><i><cite></cite></i></a>
        </div>
        <a class="appraisalBtn" data-reveal-id="myModal">
            一键测评
        </a>

    </div>
    <div id="myModal" class="reveal-modal">
        <a class="close-reveal-modal">&#215;</a>
        <div id="myModal2"></div>
    </div>
</div>


<script>
    var token = getQueryString('token');
    //    token = "1bad9f11-11aa-46dd-94e3-cd05e20021c5";
    var allAnswer = JSON.parse(localStorage.getItem('allAnswer')) || [];
    localStorage.setItem('zizhen_token', token);
    var index = 1;

    $.ajax({
        type: "post",
        url: urls.DIAGNOSIS_GETEVALUATIONRESULT,
        headers: {
            authorization: token
        },
        success: function (res) {
            if (res.ok) {
                console.log(res);
                $(".appraisalBtn").html('重新测评');
                appraisal_init(res.obj.physiology, res.obj.psychology, res.obj.social, res.obj.self);
            }
        },
        error: function () {
            console.log('err')
        }
    });
    /*
     * 比例填充
     * */
    var appraisalsl = localStorage.getItem('appraisalsl') || "00" + "%";
    var appraisalxl = localStorage.getItem('appraisalxl') || "00" + "%";
    var appraisalsj = localStorage.getItem('appraisalsj') || "00" + "%";
    var appraisalzc = localStorage.getItem('appraisalzc') || "00" + "%";
    $(".appraisalsl span").html(appraisalsl);
    $(".appraisalsl cite").css('width', 1.3 * parseInt(appraisalsl));
    $(".appraisalxl span").html(appraisalxl);
    $(".appraisalxl cite").css('width', 1.3 * parseInt(appraisalxl));
    $(".appraisalsj span").html(appraisalsj);
    $(".appraisalsj cite").css('width', 1.3 * parseInt(appraisalsj));
    $(".appraisalzc span").html(appraisalzc);
    $(".appraisalzc cite").css('width', 1.3 * parseInt(appraisalzc));


    /*
     * 点击测评
     * */
    var url = "assessmentTest.html"; //被加载的页面url
    $('.appraisalsl').click(function () {
        localStorage.setItem('questionsType', "生理测评");
        questionnaireType = [1, "生理测评", 'appraisalsl'];
        testAjax();
    });
    $('.appraisalxl').click(function () {
        localStorage.setItem('questionsType', "心理测评");
        questionnaireType = [2, "心理测评", 'appraisalxl'];
        testAjax();
    });
    $('.appraisalsj').click(function () {
        localStorage.setItem('questionsType', "社交测评");
        questionnaireType = [3, "社交测评", 'appraisalsj'];
        testAjax();
    });
    $('.appraisalzc').click(function () {
        localStorage.setItem('questionsType', "自测测评");
        questionnaireType = [4, "自测测评", 'appraisalzc'];
        testAjax();
    });
    $('.appraisalBtn').click(function () {
        localStorage.setItem('questionsType', "一键测评");
        questionnaireType = [0, "一键测评", 'all'];
        testAjax();
    });

    function appraisal_init(a, b, c, d) {
        var userInformation = {
            'zhengzhuangSocre': a,
            'xinliSocre': b,
            'shehuiSocre': c,
            'ziceSocre': d
        }
        //document.getElementById('countSocre').innerHTML=userInformation.countSocre;
        var svg1 = document.getElementById("svg_zhengzhuang");
        var svg2 = document.getElementById("svg_xinli");
        var svg3 = document.getElementById("svg_shehui");
        var svg4 = document.getElementById("svg_zice");
        var percent1 = Math.round(parseFloat(userInformation.zhengzhuangSocre)) / 100,
            perimeter1 = Math.PI * 2 * 60;
        var percent2 = Math.round(parseFloat(userInformation.xinliSocre)) / 100,
            perimeter2 = Math.PI * 2 * 70;
        var percent3 = Math.round(parseFloat(userInformation.shehuiSocre)) / 100,
            perimeter3 = Math.PI * 2 * 80;
        var percent4 = Math.round(parseFloat(userInformation.ziceSocre)) / 100,
            perimeter4 = Math.PI * 2 * 90;
        svg1.setAttribute('stroke-dasharray', perimeter1 * percent1 + " " + perimeter1 * (1 - percent1));
        svg2.setAttribute('stroke-dasharray', perimeter2 * percent2 + " " + perimeter2 * (1 - percent2));
        svg3.setAttribute('stroke-dasharray', perimeter3 * percent3 + " " + perimeter3 * (1 - percent3));
        svg4.setAttribute('stroke-dasharray', perimeter4 * percent4 + " " + perimeter4 * (1 - percent4));
    }

    /*******************************************************************************************************/

    function testAjax() {
//        $("#myModal2").html("");
        $("#myModal2").load(url, null);
        index = 1;
        key = questionnaireType[2] + "answer";
        answers = JSON.parse(localStorage.getItem(key)) || [];
        _json = [];
        $.ajax({
            type: "post",
            url: urls.DIAGNOSIS_GETQUESTIONNAIRELIST,
            headers: {
                authorization: token
            },
            data: {
                type: questionnaireType[0]
            },
            success: function (res) {
                _json = res.obj;
                var nowI = parseInt(localStorage.getItem(questionnaireType[2]));
                if (nowI) {
                    index = Math.ceil(_json.length * nowI / 100);
                }
                fun_getCurQuestion();
            },
            error: function () {
                console.log('err')
            }
        });
    }

    mui('#myModal2').on('tap', 'button', function () {
        var btnId = this.getAttribute('id');
        if (btnId == 'up') {
            index--;
        } else if (btnId == 'next') {
            index++;
        } else {
            fun_submit();
            return false;
        }
        fun_getCurQuestion();
    });

    // 设置当前问题及答案
    function fun_getCurQuestion() {

        if (index != 1) {
            localStorage.setItem(questionnaireType[2], JSON.stringify(Math.ceil((index - 1) / _json.length * 100)) + "%");
            $("." + questionnaireType[2] + " span").html(Math.ceil((index - 1) / _json.length * 100) + "%");
            $("." + questionnaireType[2] + " cite").css('width', 1.3 * Math.ceil((index - 1) / _json.length * 100));
        }
        fun_setButton();
        $("#sum").html(index + "/" + _json.length);
        var curQuestion = _json[index - 1];
        setTimeout(function () {
            $("#question").html(index + " 、" + curQuestion.title);

            $("#questionImg").attr('src', urls.IMGSRC + curQuestion.img);
            $("#answer1").html(fun_createRadio(curQuestion, 0, 'A') + "<label style ='text-align:left;margin-left:28px;'>A&nbsp;&nbsp;&nbsp;" + curQuestion.answer[0] + "</label>");
            $("#answer2").html(fun_createRadio(curQuestion, 1, 'B') + "<label style ='text-align:left;margin-left:28px;'>B&nbsp;&nbsp;&nbsp;" + curQuestion.answer[1] + "</label>");
            $("#answer3").html(fun_createRadio(curQuestion, 2, 'C') + "<label style ='text-align:left;margin-left:28px;'>C&nbsp;&nbsp;&nbsp;" + curQuestion.answer[2] + "</label>");
            $("#answer4").html(fun_createRadio(curQuestion, 3, 'D') + "<label style ='text-align:left;margin-left:28px;'>D&nbsp;&nbsp;&nbsp;" + curQuestion.answer[3] + "</label>");
            $("#answer5").html(fun_createRadio(curQuestion, 4, 'E') + "<label style ='text-align:left;margin-left:28px;'>E&nbsp;&nbsp;&nbsp;" + curQuestion.answer[4] + "</label>");
            fun_showProgress(index);

        }, 300)
    }

    function fun_showProgress(index) {

        // 显示进度
        mui("#demo5 .mui-progressbar").each(function () {
            mui(this).progressbar({
                progress: (index - 1) / _json.length * 100
            }).show();
        });
    }

    // 生成单选按钮
    function fun_createRadio(question, answer, order) {
        var _radio = '<input class="iradio_square-blue" type="radio" style="-webkit-appearance: none;left:20px;" name="' + question.id + '&' + order + '"';
        _radio += ' value="' + question.asnwerScore[answer] + '"';
        if (answers[question.id] == question.asnwerScore[answer]) {
            _radio += ' checked="checked"';
        }
        _radio += ' onclick="fun_recordingAnswer(this);">';
        return _radio;
    }


    // 记录答案
    function fun_recordingAnswer(obj) {
        var order = obj.name.split('&');
        $(obj).addClass('checked');
        if (index == _json.length) {
            fun_showProgress(index + 1);
            answers[index - 1] = {
                id: order[0],
                score: obj.value,
                answer: order[1]
            };
            localStorage.setItem(key, JSON.stringify(answers));
            fun_submit();
            return false;
        }
        answers[index - 1] = {
            id: order[0],
            score: obj.value,
            answer: order[1]
        };
        localStorage.setItem(key, JSON.stringify(answers));

        index++;
        fun_getCurQuestion();
//        window.setTimeout("fun_getCurQuestion()", 300);
    }

    // 设置问题上一题/下一题按钮是否可用
    function fun_setButton() {
        if (index == 1) {
            //plus.nativeUI.toast('当前问题已经是第一题');
//            document.getElementById("up").style.display = 'none';
            $("#up").css('display', 'none');

        } else if (index == _json.length) {
            $("#next").css('display', 'none');
            $("#up").css('display', 'block');
            $("#submit").css('display', 'block');

        } else {
            $("#up").css('display', 'block');
            $("#next").css('display', 'block');
            $("#submit").css('display', 'none');
        }
    }
    // 提交答案
    function fun_submit() {
        var btnArray;
        btnArray = ['取消', '确定'];
        mui.confirm('是否提交问卷', '温馨提示', btnArray, function (e) {

            for (var i in _json) {
                if (!answers[i]) {
                    answers[i] = {
                        id: _json[i].id,
                        score: _json[i].asnwerScore[0],
                        answer: 'A'
                    }
                }
            }

            if (e.index == 1) {
                countScore(answers);
                localStorage.removeItem(key);
                localStorage.removeItem(questionnaireType[2]);
            } else {

            }

        });
    }

    //提交问卷
    function countScore(answers) {
        var arr = answers;
        if (questionnaireType[0] != 0) {
            for (var i = 0; i < 4; i++) {
                if (i + 1 != questionnaireType[0] && allAnswer[i]) {
                    arr = arr.concat(allAnswer[i]);
                }
            }
        }
        $.ajax({
            url: urls.DIAGNOSIS_SUBMITQUESTIONNAIRERESULT,
            headers: {
                authorization: token
            },
            data: {
                result: JSON.stringify(arr)
            },
            dataType: 'json',
            type: 'post',
            timeout: 20000, //超时时间设置为20秒；
            success: function (data) {
                allAnswer[questionnaireType[0] - 1] = answers;
                localStorage.setItem('allAnswer', JSON.stringify(allAnswer));
                window.location.href = "assessmentResult.html";
            },
            error: function (xhr, type, errorThrown) {
            }
        });


    }


</script>

</body>
</html>